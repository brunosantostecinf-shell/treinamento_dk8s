Vamos criar o nosso ServiceMonitor com o seguinte arquivo YAML:

```
apiVersion: monitoring.coreos.com/v1 # vers√£o da API
kind: ServiceMonitor # tipo de recurso, no caso, um ServiceMonitor do Prometheus Operator
metadata: # metadados do recurso
  name: nginx-servicemonitor # nome do recurso
  labels: # labels do recurso
    app: nginx # label que identifica o app
spec: # especifica√ß√£o do recurso
  selector: # seletor para identificar os pods que ser√£o monitorados
    matchLabels: # labels que identificam os pods que ser√£o monitorados
      app: nginx # label que identifica o app que ser√° monitorado
  endpoints: # endpoints que ser√£o monitorados
    - interval: 10s # intervalo de tempo entre as requisi√ß√µes
      path: /metrics # caminho para a requisi√ß√£o
      targetPort: 9113 # porta do target
```

Agora vamos entender o que est√° acontecendo no nosso arquivo YAML.

- - apiVersion: Vers√£o da API do Kubernetes que estamos utilizando.
- kind: Tipo de objeto que estamos criando, no nosso caso, um ServiceMonitor.
- metadata: Informa√ß√µes sobre o objeto que estamos criando.
- metadata.name: Nome do nosso objeto.
- metadata.labels: Labels que ser√£o utilizadas para identificar o nosso objeto.
- spec: Especifica√ß√µes do nosso objeto.
- spec.selector: Seletor que ser√° utilizado para identificar o nosso Service.
- spec.selector.matchLabels: Labels que ser√£o utilizadas para identificar o nosso Service, no nosso caso, o Service que tem a label - app: nginx.
- spec.endpoints: Endpoints que ser√£o monitorados pelo Prometheus.
- spec.endpoints.interval: Intervalo de tempo que o Prometheus ir√° capturar as m√©tricas, no nosso caso, 15 segundos.
- spec.endpoints.path: Caminho que o Prometheus ir√° fazer a requisi√ß√£o para capturar as m√©tricas, no nosso caso, /metrics.
- spec.endpoints.targetPort: Porta que o Prometheus ir√° fazer a requisi√ß√£o para capturar as m√©tricas, no nosso caso, 9113.
- Vamos criar o nosso ServiceMonitor com o seguinte comando:

```
kubectl apply -f nginx-service-monitor.yaml
```

Ap√≥s o nosso ServiceMonitor ser criado, vamos verificar se o nosso ServiceMonitor est√° rodando:

```
kubectl get servicemonitors
```

Maravilha! Agora que j√° temos o nosso Nginx rodando e as m√©tricas sendo expostas, vamos verificar se o Prometheus est√° capturando as m√©tricas do Nginx e do Nginx Exporter.

Vamos fazer o port-forward do Prometheus para acessar o Prometheus localmente:

```
kubectl port-forward -n monitoring svc/prometheus-k8s 39090:9090
```
E agora vamos usar o curl para verificar se o Prometheus est√° capturando as m√©tricas do Nginx e do Nginx Exporter:

```
curl http://localhost:39090/api/v1/targets
```

Pronto, agora voc√™ j√° sabe como que faz para criar um Service no Kubernetes, expor as m√©tricas do Nginx e do Nginx Exporter e ainda criar um ServiceMonitor para o seu Service ficar monitorado pelo Prometheus. \o/

√â muito importante que voc√™ saiba que o Prometheus n√£o captura as m√©tricas automaticamente, ele precisa de um ServiceMonitor para capturar as m√©tricas. üòÑ


